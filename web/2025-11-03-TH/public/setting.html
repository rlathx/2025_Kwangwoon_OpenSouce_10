<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Memory Archive | ì„¤ì •</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
    <link rel="stylesheet" href="option_style.css" />
</head>

<body>
    <div class="settings-card">
        <h1><i class="bi bi-sliders"></i> ì„¤ì •</h1>

        <!-- MBTI -->
        <div class="mb-3">
            <label for="mbtiSelect" class="form-label">MBTI ì„ íƒ</label>
            <select id="mbtiSelect" class="form-select">
                <option value="" selected>ì„ íƒí•˜ì„¸ìš”</option>
                <option>INTJ</option>
                <option>INTP</option>
                <option>ENTJ</option>
                <option>ENTP</option>
                <option>INFJ</option>
                <option>INFP</option>
                <option>ENFJ</option>
                <option>ENFP</option>
                <option>ISTJ</option>
                <option>ISFJ</option>
                <option>ESTJ</option>
                <option>ESFJ</option>
                <option>ISTP</option>
                <option>ISFP</option>
                <option>ESTP</option>
                <option>ESFP</option>
            </select>
        </div>

        <div class="sep"></div>

        <!-- ì˜¤ëŠ˜ì˜ ì§ˆë¬¸ ì„¤ì • -->
        <div class="mb-3">
            <label for="qSource" class="form-label">ì˜¤ëŠ˜ì˜ ì§ˆë¬¸ ì„¤ì •</label>
            <select id="qSource" class="form-select">
                <option value="default">ê¸°ë³¸ ì§ˆë¬¸(10ê°œ ì œê³µ)</option>
                <option value="mbti">MBTI ë§ì¶¤ ì§ˆë¬¸</option>
                <option value="custom">ì‚¬ìš©ì ì •ì˜ ì§ˆë¬¸</option>
            </select>
            <div class="form-text">ì„ íƒí•œ ì§ˆë¬¸ ì„¤ì •ì´ diaryì— ì ìš©ë©ë‹ˆë‹¤.</div>
        </div>

        <!-- ì‚¬ìš©ì ì •ì˜ ì§ˆë¬¸ -->
        <div class="mb-3" id="customQsWrap">
            <label class="form-label">ë‚˜ë§Œì˜ ì§ˆë¬¸ ì¶”ê°€</label>
            <div class="input-group mb-2">
                <input type="text" id="myQInput" class="form-control" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ê³  â€˜ì¶”ê°€â€™ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”" />
                <button class="btn btn-outline-primary" id="btnAddMyQ"><i class="bi bi-plus-lg"></i> ì¶”ê°€</button>
            </div>
            <ul class="list-group" id="myQList"></ul>
            <div class="hint mt-1">â€˜ì‚¬ìš©ì ì •ì˜ ì§ˆë¬¸â€™ì„ ì„ íƒí•˜ë©´ ì´ ëª©ë¡ì˜ ì§ˆë¬¸ì´ ì‚¬ìš©ë©ë‹ˆë‹¤.</div>
        </div>

        <div class="sep"></div>

        <!-- ì˜¤ëŠ˜ì˜ í•œë§ˆë”” -->
        <div class="mb-3">
            <label for="quoteMode" class="form-label">ì˜¤ëŠ˜ì˜ í•œë§ˆë”” ì„¤ì •</label>
            <select id="quoteMode" class="form-select">
                <option value="quote">ëª…ì–¸(ëœë¤)</option>
                <option value="mbti">MBTIë³„ ë§ì¶¤ í•œë§ˆë””</option>
            </select>
            <div class="form-text">ì„ íƒí•œ ë°©ì‹ì´ ë©”ì¸/ì¼ê¸° í˜ì´ì§€ì˜ â€˜ì˜¤ëŠ˜ì˜ í•œë§ˆë””â€™ì— ì ìš©ë©ë‹ˆë‹¤.</div>
        </div>

        <div class="sep"></div>

        <!-- ì €ì¥ & ëŒì•„ê°€ê¸° -->
        <div class="d-flex align-items-center gap-2">
            <button class="btn btn-primary" id="btnSave">ì €ì¥</button>
            <span class="badge bg-success ok-badge" id="savedOk"><i class="bi bi-check2"></i>&nbsp;ì €ì¥ë¨</span>
            <a href="index.html" class="btn btn-outline-secondary ms-auto">
                <i class="bi bi-arrow-left"></i> ëŒì•„ê°€ê¸°
            </a>
        </div>
    </div>

    <script>
        let currentSettings = {};
        let customQuestions = [];

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.onload = async () => {
            await loadSettings();
            await loadCustomQuestions();
            renderCustomQuestions();
        };

        // ì„¤ì • ë¡œë“œ
        async function loadSettings() {
            try {
                const response = await fetch('/api/settings');
                currentSettings = await response.json();

                // ë¼ë””ì˜¤ ë²„íŠ¼ ì„¤ì •
                document.querySelector(`input[name="questionType"][value="${currentSettings.questionType}"]`).checked = true;
                document.querySelector(`input[name="messageType"][value="${currentSettings.messageType}"]`).checked = true;

                // MBTI ì„ íƒ ì„¤ì •
                document.getElementById('mbtiSelect').value = currentSettings.selectedMBTI;
                document.getElementById('mbtiMessageSelect').value = currentSettings.selectedMBTI;

                // ì¡°ê±´ë¶€ í‘œì‹œ
                updateQuestionType();
                updateMessageType();
            } catch (error) {
                console.error('ì„¤ì • ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ì‚¬ìš©ì ì •ì˜ ì§ˆë¬¸ ë¡œë“œ
        async function loadCustomQuestions() {
            try {
                const response = await fetch('/api/questions');
                const data = await response.json();
                customQuestions = data.custom || [];
            } catch (error) {
                console.error('ì§ˆë¬¸ ë¡œë“œ ì‹¤íŒ¨:', error);
                customQuestions = [];
            }
        }

        // ì§ˆë¬¸ ìœ í˜• ë³€ê²½ ì‹œ
        function updateQuestionType() {
            const questionType = document.querySelector('input[name="questionType"]:checked').value;
            const mbtiSelector = document.getElementById('mbtiSelector');

            if (questionType === 'mbti') {
                mbtiSelector.style.display = 'block';
            } else {
                mbtiSelector.style.display = 'none';
            }

            saveSettings();
        }

        // ë©”ì‹œì§€ ìœ í˜• ë³€ê²½ ì‹œ
        function updateMessageType() {
            const messageType = document.querySelector('input[name="messageType"]:checked').value;
            const mbtiMessageSelector = document.getElementById('mbtiMessageSelector');

            if (messageType === 'mbti') {
                mbtiMessageSelector.style.display = 'block';
            } else {
                mbtiMessageSelector.style.display = 'none';
            }

            saveSettings();
        }

        // ì„¤ì • ì €ì¥
        async function saveSettings() {
            const questionType = document.querySelector('input[name="questionType"]:checked').value;
            const messageType = document.querySelector('input[name="messageType"]:checked').value;
            const selectedMBTI = document.getElementById('mbtiSelect').value;

            const settings = {
                questionType: questionType,
                messageType: messageType,
                selectedMBTI: selectedMBTI
            };

            try {
                const response = await fetch('/api/settings', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settings)
                });

                if (response.ok) {
                    console.log('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ì„¤ì • ì €ì¥ ì‹¤íŒ¨:', error);
                alert('ì„¤ì • ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì‚¬ìš©ì ì •ì˜ ì§ˆë¬¸ ì¶”ê°€
        async function addCustomQuestion() {
            const input = document.getElementById('newQuestionInput');
            const question = input.value.trim();

            if (!question) {
                alert('ì§ˆë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }

            try {
                const response = await fetch('/api/questions/custom', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ question: question })
                });

                if (response.ok) {
                    input.value = '';
                    await loadCustomQuestions();
                    renderCustomQuestions();
                    alert('ì§ˆë¬¸ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤! âœ…');
                } else {
                    alert('ì§ˆë¬¸ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ì§ˆë¬¸ ì¶”ê°€ ì‹¤íŒ¨:', error);
                alert('ì§ˆë¬¸ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì‚¬ìš©ì ì •ì˜ ì§ˆë¬¸ ì‚­ì œ
        async function deleteCustomQuestion(index) {
            if (!confirm('ì´ ì§ˆë¬¸ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }

            try {
                const response = await fetch(`/api/questions/custom/${index}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    await loadCustomQuestions();
                    renderCustomQuestions();
                    alert('ì§ˆë¬¸ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                } else {
                    alert('ì§ˆë¬¸ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ì§ˆë¬¸ ì‚­ì œ ì‹¤íŒ¨:', error);
                alert('ì§ˆë¬¸ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì‚¬ìš©ì ì •ì˜ ì§ˆë¬¸ ë Œë”ë§
        function renderCustomQuestions() {
            const listDiv = document.getElementById('customQuestionsList');

            if (customQuestions.length === 0) {
                listDiv.innerHTML = '<p class="empty-message">ì•„ì§ ì¶”ê°€ëœ ì§ˆë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            listDiv.innerHTML = customQuestions.map((question, index) => `
                <div class="question-item">
                    <span class="question-text">${question}</span>
                    <button class="btn btn-delete" onclick="deleteCustomQuestion(${index})">ğŸ—‘ï¸ ì‚­ì œ</button>
                </div>
            `).join('');
        }
    </script>
</body>

</html>
