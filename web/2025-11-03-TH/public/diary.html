<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Memory Archive | Diary</title>

    <link rel="stylesheet" href="diary_style.css" />
</head>

<body>
    <div class="diary-container">
        <div class="diary-header">
            <h1>ì˜¤ëŠ˜ì˜ ê¸°ë¡ âœï¸</h1>
            <p>ê¸°ì–µì„ ë‹´ëŠ” í•˜ë£¨, Memory Archive</p>
        </div>

        <div class="diary-meta">
            <div class="meta-row">
                <span class="meta-label">ë‚ ì§œ:</span>
                <span class="meta-value" id="dateText">â€”</span>
            </div>
            <div class="meta-row">
                <span class="meta-label">ê¸°ë¶„:</span>
                <span class="meta-value" id="moodNow">â€”</span>
            </div>
            <div class="meta-row">
                <span class="meta-label">ë‚ ì”¨:</span>
                <span class="meta-value" id="weatherNow">â€”</span>
            </div>
        </div>

        <!-- ì˜¤ëŠ˜ì˜ ì§ˆë¬¸ -->
        <div class="question-section">
            <h3>ì˜¤ëŠ˜ì˜ ì§ˆë¬¸ ğŸ’­</h3>
            <ul id="question-list"></ul>
        </div>

        <!-- ì¼ê¸° ì…ë ¥ -->
        <textarea id="note" placeholder="ì˜¤ëŠ˜ì˜ í•˜ë£¨ë¥¼ ê¸°ë¡í•´ë³´ì„¸ìš”... âœ¨"></textarea>

        <!-- ë²„íŠ¼ -->
        <div class="button-row">
            <button type="button" class="btn" id="btnBack">â† ë’¤ë¡œê°€ê¸°</button>
            <button type="button" class="btn save" id="btnSave">ì €ì¥í•˜ê¸° ğŸ’¾</button>
        </div>

        <!-- ê¸°ë¶„ / ë‚ ì”¨ -->
        <div class="emoji-section">
            <h3>ì˜¤ëŠ˜ì˜ ê¸°ë¶„ì€ ì–´ë–¤ê°€ìš”?</h3>
            <div class="emoji-list" id="moodList">
                <span class="emoji-item">ğŸ˜Š</span><span class="emoji-item">ğŸ˜¢</span><span class="emoji-item">ğŸ˜¡</span>
                <span class="emoji-item">ğŸ˜</span><span class="emoji-item">ğŸ˜´</span><span class="emoji-item">ğŸ¥³</span>
                <span class="emoji-item">ğŸ˜</span><span class="emoji-item">ğŸ¤”</span><span class="emoji-item">ğŸ˜­</span>
            </div>

            <h3>ì˜¤ëŠ˜ì˜ ë‚ ì”¨ëŠ” ì–´ë–¤ê°€ìš”?</h3>
            <div class="emoji-list" id="weatherList">
                <span class="emoji-item">â˜€ï¸</span><span class="emoji-item">ğŸŒ¤ï¸</span><span class="emoji-item">â›…</span>
                <span class="emoji-item">ğŸŒ§ï¸</span><span class="emoji-item">â›ˆï¸</span><span class="emoji-item">â„ï¸</span>
                <span class="emoji-item">ğŸŒ¨ï¸</span><span class="emoji-item">ğŸŒˆ</span><span class="emoji-item">ğŸ’¨</span>
            </div>
        </div>
    </div>


    <script>
        let currentQuestion = '';
        let currentMessage = '';

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.onload = async () => {
            await loadTodayMessage();
            await loadTodayQuestion();
            await loadTodayDiary();
        };

        // ì˜¤ëŠ˜ì˜ í•œ ë§ˆë”” ë¡œë“œ
        async function loadTodayMessage() {
            try {
                const response = await fetch('/api/today-message');
                const data = await response.json();

                currentMessage = data.message;
                const messageBox = document.getElementById('todayMessage');

                if (data.type === 'mbti') {
                    messageBox.innerHTML = `
                        <h3>ğŸ’¬ ${data.mbti}ì˜ í•œ ë§ˆë””</h3>
                        <p>${data.message}</p>
                    `;
                } else {
                    messageBox.innerHTML = `
                        <h3>ğŸ’¬ ì˜¤ëŠ˜ì˜ ëª…ì–¸</h3>
                        <p>${data.message}</p>
                    `;
                }
            } catch (error) {
                console.error('ë©”ì‹œì§€ ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('todayMessage').innerHTML =
                    '<p class="error">ë©”ì‹œì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
            }
        }

        // ì˜¤ëŠ˜ì˜ ì§ˆë¬¸ ë¡œë“œ
        async function loadTodayQuestion() {
            try {
                const response = await fetch('/api/today-question');
                const data = await response.json();

                currentQuestion = data.question;
                const questionBox = document.getElementById('todayQuestion');
                questionBox.innerHTML = `
                    <h3>â“ ì˜¤ëŠ˜ì˜ ì§ˆë¬¸</h3>
                    <p>${data.question}</p>
                `;
            } catch (error) {
                console.error('ì§ˆë¬¸ ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('todayQuestion').innerHTML =
                    '<p class="error">ì§ˆë¬¸ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
            }
        }

        // ì˜¤ëŠ˜ ë‚ ì§œì˜ ì¼ê¸°ê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ê³  ë¡œë“œ
        async function loadTodayDiary() {
            const today = getTodayDate();
            try {
                const response = await fetch(`/api/diaries/${today}`);
                if (response.ok) {
                    const diary = await response.json();

                    // ê¸°ì¡´ ì¼ê¸° ë‚´ìš© ë¡œë“œ
                    document.getElementById('diaryContent').value = diary.content;
                    document.getElementById('moodSelect').value = diary.mood;
                    document.getElementById('weatherSelect').value = diary.weather;
                }
            } catch (error) {
                // ì¼ê¸°ê°€ ì—†ìœ¼ë©´ ê·¸ëƒ¥ ë¹ˆ ìƒíƒœë¡œ ì‹œì‘
                console.log('ì˜¤ëŠ˜ ì‘ì„±ëœ ì¼ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.');
            }
        }

        // ì¼ê¸° ì €ì¥
        async function saveDiary() {
            const content = document.getElementById('diaryContent').value.trim();
            const mood = document.getElementById('moodSelect').value;
            const weather = document.getElementById('weatherSelect').value;

            if (!content) {
                alert('ì¼ê¸° ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }

            const today = getTodayDate();

            const diaryData = {
                date: today,
                content: content,
                mood: mood,
                weather: weather,
                question: currentQuestion,
                message: currentMessage
            };

            try {
                const response = await fetch('/api/diaries', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(diaryData)
                });

                if (response.ok) {
                    alert('ì¼ê¸°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ“');
                    // ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™
                    window.location.href = 'index.html';
                } else {
                    alert('ì¼ê¸° ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                }
            } catch (error) {
                console.error('ì €ì¥ ì˜¤ë¥˜:', error);
                alert('ì¼ê¸° ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì¼ê¸° ì´ˆê¸°í™”
        function clearDiary() {
            if (confirm('ì‘ì„± ì¤‘ì¸ ë‚´ìš©ì„ ëª¨ë‘ ì§€ìš°ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                document.getElementById('diaryContent').value = '';
                document.getElementById('moodSelect').selectedIndex = 0;
                document.getElementById('weatherSelect').selectedIndex = 0;
            }
        }

        // ì˜¤ëŠ˜ ë‚ ì§œ ê°€ì ¸ì˜¤ê¸° (YYYY-MM-DD í˜•ì‹)
        function getTodayDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
    </script>
</body>

</html>
