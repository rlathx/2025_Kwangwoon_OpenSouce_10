<!-- main page -->

<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í…Œë§ˆ ì¼ê¸° - ë©”ì¸</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="container">
        <header>
            <h1>ğŸ“” í…Œë§ˆ ì¼ê¸°</h1>
            <nav>
                <a href="index.html" class="active">ë©”ì¸</a>
                <a href="diary.html">ì¼ê¸° ì“°ê¸°</a>
                <a href="setting.html">ì„¤ì •</a>
            </nav>
        </header>

        <main>
            <!-- ì˜¤ëŠ˜ì˜ í•œ ë§ˆë”” -->
            <section class="today-message">
                <h2>ğŸ’¬ ì˜¤ëŠ˜ì˜ í•œ ë§ˆë””</h2>
                <div id="messageContent" class="message-box">
                    <p class="loading">ë¡œë”© ì¤‘...</p>
                </div>
            </section>

            <!-- ë‹¬ë ¥ -->
            <section class="calendar-section">
                <div class="month-nav">
                    <button onclick="changeMonth(-1)" class="nav-btn">â—€ ì´ì „</button>
                    <h2 id="currentMonth"></h2>
                    <button onclick="changeMonth(1)" class="nav-btn">ë‹¤ìŒ â–¶</button>
                </div>

                <div class="calendar" id="calendarGrid">
                    <!-- ë‹¬ë ¥ì´ ì—¬ê¸°ì— ë Œë”ë§ë©ë‹ˆë‹¤ -->
                </div>
            </section>
        </main>
    </div>

    <!-- ì¼ê¸° ë³´ê¸° ëª¨ë‹¬ -->
    <div id="diaryModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2 id="modalDate"></h2>
            <div id="modalContent"></div>
        </div>
    </div>

    <script>
        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth();
        let diariesData = {};

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.onload = async () => {
            await loadTodayMessage();
            await loadDiaries();
            renderCalendar();
        };

        // ì˜¤ëŠ˜ì˜ í•œ ë§ˆë”” ë¡œë“œ
        async function loadTodayMessage() {
            try {
                const response = await fetch('/api/today-message');
                const data = await response.json();

                const messageBox = document.getElementById('messageContent');
                if (data.type === 'mbti') {
                    messageBox.innerHTML = `
                        <p class="message-type">${data.mbti}ì˜ í•œ ë§ˆë””</p>
                        <p class="message-text">${data.message}</p>
                    `;
                } else {
                    messageBox.innerHTML = `
                        <p class="message-type">ì˜¤ëŠ˜ì˜ ëª…ì–¸</p>
                        <p class="message-text">${data.message}</p>
                    `;
                }
            } catch (error) {
                console.error('ë©”ì‹œì§€ ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('messageContent').innerHTML =
                    '<p class="error">ë©”ì‹œì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
            }
        }

        // ì¼ê¸° ë°ì´í„° ë¡œë“œ
        async function loadDiaries() {
            try {
                const response = await fetch('/api/diaries');
                diariesData = await response.json();
            } catch (error) {
                console.error('ì¼ê¸° ë¡œë“œ ì‹¤íŒ¨:', error);
                diariesData = {};
            }
        }

        // ë‹¬ë ¥ ë Œë”ë§
        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            const monthDisplay = document.getElementById('currentMonth');

            monthDisplay.textContent = `${currentYear}ë…„ ${currentMonth + 1}ì›”`;

            // ë‹¬ë ¥ ì´ˆê¸°í™”
            grid.innerHTML = '';

            // ìš”ì¼ í—¤ë”
            const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
            days.forEach((day, index) => {
                const header = document.createElement('div');
                header.className = 'calendar-header';
                if (index === 0) header.classList.add('sunday');
                if (index === 6) header.classList.add('saturday');
                header.textContent = day;
                grid.appendChild(header);
            });

            // ì²«ë‚ ê³¼ ë§ˆì§€ë§‰ ë‚  ê³„ì‚°
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const lastDate = new Date(currentYear, currentMonth + 1, 0).getDate();

            // ë¹ˆ ì¹¸ ì±„ìš°ê¸°
            for (let i = 0; i < firstDay; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'calendar-day empty';
                grid.appendChild(emptyCell);
            }

            // ë‚ ì§œ ì±„ìš°ê¸°
            for (let date = 1; date <= lastDate; date++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';

                const dateKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(date).padStart(2, '0')}`;
                const diary = diariesData[dateKey];

                // ì˜¤ëŠ˜ ë‚ ì§œ í‘œì‹œ
                const today = new Date();
                if (currentYear === today.getFullYear() &&
                    currentMonth === today.getMonth() &&
                    date === today.getDate()) {
                    dayElement.classList.add('today');
                }

                if (diary) {
                    dayElement.classList.add('has-diary');
                    const weatherColor = getWeatherColor(diary.weather);
                    dayElement.style.background = weatherColor;
                    dayElement.innerHTML = `
                        <div class="date-number">${date}</div>
                        <div class="mood-emoji">${diary.mood}</div>
                    `;
                    dayElement.onclick = () => viewDiary(dateKey, diary);
                } else {
                    dayElement.innerHTML = `<div class="date-number">${date}</div>`;
                }

                grid.appendChild(dayElement);
            }
        }

        // ë‚ ì”¨ë³„ ìƒ‰ìƒ ë°˜í™˜
        function getWeatherColor(weather) {
            const colors = {
                'sunny': '#FFE5B4',
                'cloudy': '#E0F2F7',
                'rainy': '#B3E5FC',
                'snowy': '#F0F0F0',
                'partly-cloudy': '#FFF9C4'
            };
            return colors[weather] || '#FFFFFF';
        }

        // ì›” ë³€ê²½
        function changeMonth(delta) {
            currentMonth += delta;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            } else if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar();
        }

        // ì¼ê¸° ë³´ê¸°
        function viewDiary(dateKey, diary) {
            const modal = document.getElementById('diaryModal');
            const modalDate = document.getElementById('modalDate');
            const modalContent = document.getElementById('modalContent');

            modalDate.textContent = `ğŸ“… ${dateKey}`;

            const weatherEmoji = getWeatherEmoji(diary.weather);
            modalContent.innerHTML = `
                <div class="diary-meta">
                    <span class="mood">${diary.mood}</span>
                    <span class="weather">${weatherEmoji}</span>
                </div>
                <div class="diary-question">
                    <strong>Q:</strong> ${diary.question}
                </div>
                <div class="diary-content">
                    ${diary.content.replace(/\n/g, '<br>')}
                </div>
            `;

            modal.style.display = 'block';
        }

        // ë‚ ì”¨ ì´ëª¨ì§€ ë°˜í™˜
        function getWeatherEmoji(weather) {
            const emojis = {
                'sunny': 'â˜€ï¸ ë§‘ìŒ',
                'cloudy': 'â˜ï¸ íë¦¼',
                'rainy': 'ğŸŒ§ï¸ ë¹„',
                'snowy': 'â„ï¸ ëˆˆ',
                'partly-cloudy': 'â›… êµ¬ë¦„ ì¡°ê¸ˆ'
            };
            return emojis[weather] || weather;
        }

        // ëª¨ë‹¬ ë‹«ê¸°
        function closeModal() {
            document.getElementById('diaryModal').style.display = 'none';
        }

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        window.onclick = function (event) {
            const modal = document.getElementById('diaryModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }
    </script>
</body>

</html>