<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í…Œë§ˆ ì¼ê¸° - ì¼ê¸° ì“°ê¸°</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="container">
        <header>
            <h1>ğŸ“” í…Œë§ˆ ì¼ê¸°</h1>
            <nav>
                <a href="index.html">ë©”ì¸</a>
                <a href="diary.html" class="active">ì¼ê¸° ì“°ê¸°</a>
                <a href="setting.html">ì„¤ì •</a>
            </nav>
        </header>

        <main>
            <section class="diary-write-section">
                <h2>âœï¸ ì˜¤ëŠ˜ì˜ ì¼ê¸°</h2>

                <!-- ì˜¤ëŠ˜ì˜ í•œ ë§ˆë”” -->
                <div class="today-message-box" id="todayMessage">
                    <p class="loading">ë¡œë”© ì¤‘...</p>
                </div>

                <!-- ì˜¤ëŠ˜ì˜ ì§ˆë¬¸ -->
                <div class="today-question-box" id="todayQuestion">
                    <p class="loading">ë¡œë”© ì¤‘...</p>
                </div>

                <!-- ê¸°ë¶„ê³¼ ë‚ ì”¨ ì„ íƒ -->
                <div class="mood-weather-selector">
                    <div class="selector-group">
                        <label for="moodSelect">ì˜¤ëŠ˜ì˜ ê¸°ë¶„</label>
                        <select id="moodSelect">
                            <option value="ğŸ˜Š">ğŸ˜Š í–‰ë³µí•´ìš”</option>
                            <option value="ğŸ˜¢">ğŸ˜¢ ìŠ¬í¼ìš”</option>
                            <option value="ğŸ˜¡">ğŸ˜¡ í™”ë‚˜ìš”</option>
                            <option value="ğŸ˜´">ğŸ˜´ í”¼ê³¤í•´ìš”</option>
                            <option value="ğŸ˜">ğŸ˜ ê·¸ì € ê·¸ë˜ìš”</option>
                            <option value="ğŸ¥°">ğŸ¥° ì„¤ë ˆìš”</option>
                            <option value="ğŸ˜°">ğŸ˜° ë¶ˆì•ˆí•´ìš”</option>
                            <option value="ğŸ˜">ğŸ˜ ë©‹ì ¸ìš”</option>
                            <option value="ğŸ¤”">ğŸ¤” ìƒê°ì´ ë§ì•„ìš”</option>
                            <option value="ğŸ˜Œ">ğŸ˜Œ í‰ì˜¨í•´ìš”</option>
                        </select>
                    </div>

                    <div class="selector-group">
                        <label for="weatherSelect">ì˜¤ëŠ˜ì˜ ë‚ ì”¨</label>
                        <select id="weatherSelect">
                            <option value="sunny">â˜€ï¸ ë§‘ìŒ</option>
                            <option value="cloudy">â˜ï¸ íë¦¼</option>
                            <option value="rainy">ğŸŒ§ï¸ ë¹„</option>
                            <option value="snowy">â„ï¸ ëˆˆ</option>
                            <option value="partly-cloudy">â›… êµ¬ë¦„ ì¡°ê¸ˆ</option>
                        </select>
                    </div>
                </div>

                <!-- ì¼ê¸° ì‘ì„± -->
                <div class="diary-editor">
                    <label for="diaryContent">ì˜¤ëŠ˜ì˜ ì´ì•¼ê¸°ë¥¼ ë“¤ë ¤ì£¼ì„¸ìš”</label>
                    <textarea id="diaryContent" placeholder="ì˜¤ëŠ˜ í•˜ë£¨ëŠ” ì–´ë• ë‚˜ìš”? ììœ ë¡­ê²Œ ì‘ì„±í•´ë³´ì„¸ìš”..." rows="15"></textarea>
                </div>

                <!-- ë²„íŠ¼ -->
                <div class="button-group">
                    <button class="btn btn-primary" onclick="saveDiary()">ğŸ’¾ ì €ì¥í•˜ê¸°</button>
                    <button class="btn btn-secondary" onclick="clearDiary()">ğŸ”„ ì´ˆê¸°í™”</button>
                </div>
            </section>
        </main>
    </div>

    <script>
        let currentQuestion = '';
        let currentMessage = '';

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.onload = async () => {
            await loadTodayMessage();
            await loadTodayQuestion();
            await loadTodayDiary();
        };

        // ì˜¤ëŠ˜ì˜ í•œ ë§ˆë”” ë¡œë“œ
        async function loadTodayMessage() {
            try {
                const response = await fetch('/api/today-message');
                const data = await response.json();

                currentMessage = data.message;
                const messageBox = document.getElementById('todayMessage');

                if (data.type === 'mbti') {
                    messageBox.innerHTML = `
                        <h3>ğŸ’¬ ${data.mbti}ì˜ í•œ ë§ˆë””</h3>
                        <p>${data.message}</p>
                    `;
                } else {
                    messageBox.innerHTML = `
                        <h3>ğŸ’¬ ì˜¤ëŠ˜ì˜ ëª…ì–¸</h3>
                        <p>${data.message}</p>
                    `;
                }
            } catch (error) {
                console.error('ë©”ì‹œì§€ ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('todayMessage').innerHTML =
                    '<p class="error">ë©”ì‹œì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
            }
        }

        // ì˜¤ëŠ˜ì˜ ì§ˆë¬¸ ë¡œë“œ
        async function loadTodayQuestion() {
            try {
                const response = await fetch('/api/today-question');
                const data = await response.json();

                currentQuestion = data.question;
                const questionBox = document.getElementById('todayQuestion');
                questionBox.innerHTML = `
                    <h3>â“ ì˜¤ëŠ˜ì˜ ì§ˆë¬¸</h3>
                    <p>${data.question}</p>
                `;
            } catch (error) {
                console.error('ì§ˆë¬¸ ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('todayQuestion').innerHTML =
                    '<p class="error">ì§ˆë¬¸ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
            }
        }

        // ì˜¤ëŠ˜ ë‚ ì§œì˜ ì¼ê¸°ê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ê³  ë¡œë“œ
        async function loadTodayDiary() {
            const today = getTodayDate();
            try {
                const response = await fetch(`/api/diaries/${today}`);
                if (response.ok) {
                    const diary = await response.json();

                    // ê¸°ì¡´ ì¼ê¸° ë‚´ìš© ë¡œë“œ
                    document.getElementById('diaryContent').value = diary.content;
                    document.getElementById('moodSelect').value = diary.mood;
                    document.getElementById('weatherSelect').value = diary.weather;
                }
            } catch (error) {
                // ì¼ê¸°ê°€ ì—†ìœ¼ë©´ ê·¸ëƒ¥ ë¹ˆ ìƒíƒœë¡œ ì‹œì‘
                console.log('ì˜¤ëŠ˜ ì‘ì„±ëœ ì¼ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.');
            }
        }

        // ì¼ê¸° ì €ì¥
        async function saveDiary() {
            const content = document.getElementById('diaryContent').value.trim();
            const mood = document.getElementById('moodSelect').value;
            const weather = document.getElementById('weatherSelect').value;

            if (!content) {
                alert('ì¼ê¸° ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }

            const today = getTodayDate();

            const diaryData = {
                date: today,
                content: content,
                mood: mood,
                weather: weather,
                question: currentQuestion,
                message: currentMessage
            };

            try {
                const response = await fetch('/api/diaries', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(diaryData)
                });

                if (response.ok) {
                    alert('ì¼ê¸°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ“');
                    // ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™
                    window.location.href = 'index.html';
                } else {
                    alert('ì¼ê¸° ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                }
            } catch (error) {
                console.error('ì €ì¥ ì˜¤ë¥˜:', error);
                alert('ì¼ê¸° ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì¼ê¸° ì´ˆê¸°í™”
        function clearDiary() {
            if (confirm('ì‘ì„± ì¤‘ì¸ ë‚´ìš©ì„ ëª¨ë‘ ì§€ìš°ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                document.getElementById('diaryContent').value = '';
                document.getElementById('moodSelect').selectedIndex = 0;
                document.getElementById('weatherSelect').selectedIndex = 0;
            }
        }

        // ì˜¤ëŠ˜ ë‚ ì§œ ê°€ì ¸ì˜¤ê¸° (YYYY-MM-DD í˜•ì‹)
        function getTodayDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
    </script>
</body>

</html>